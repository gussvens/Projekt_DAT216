/*!CK:1288371364!*//*1457450390,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["MtNDg"]); }

__d('DataViewPolyfill',[],function a(b,c,d,e,f,g){'use strict';if(c.__markCompiled)c.__markCompiled();function h(i,j,k){if(j===undefined){this.$DataViewPolyfill1=new Uint8Array(i);}else if(k===undefined){this.$DataViewPolyfill1=new Uint8Array(i,j);}else this.$DataViewPolyfill1=new Uint8Array(i,j,k);this.byteLength=this.$DataViewPolyfill1.byteLength;}h.prototype.getUint8=function(i){if(i>=this.$DataViewPolyfill1.length)throw new Error('Trying to read beyond bounds of DataViewPolyfill');return this.$DataViewPolyfill1[i];};h.prototype.getUint16=function(i,j){var k=this.getUint8(i),l=this.getUint8(i+1);return j?l*256+k:k*256+l;};h.prototype.getUint32=function(i,j){var k=this.getUint8(i),l=this.getUint8(i+1),m=this.getUint8(i+2),n=this.getUint8(i+3);return j?((n*256+m)*256+l)*256+k:((k*256+l)*256+m)*256+n;};h.isSupported=function(){return !!b.Uint8Array;};f.exports=h;},null);
__d('getImageSize',['DataViewPolyfill'],function a(b,c,d,e,f,g){if(c.__markCompiled)c.__markCompiled();var h=b.DataView||c('DataViewPolyfill');function i(m){return {width:m.getUint16(6,true),height:m.getUint16(8,true)};}function j(m){return {width:m.getUint32(16,false),height:m.getUint32(20,false)};}function k(m){var n=m.byteLength,o=2;while(o<n){var p=m.getUint16(o,false);o+=2;if(p==65472||p==65474){return {width:m.getUint16(o+5,false),height:m.getUint16(o+3,false)};}else o+=m.getUint16(o,false);}return null;}function l(m){var n=new h(m);if(n.getUint8(0)==255&&n.getUint8(1)==216)return k(n);if(n.getUint8(0)==71&&n.getUint8(1)==73&&n.getUint8(2)==70)return i(n);if(n.getUint8(0)==137&&n.getUint8(1)==80&&n.getUint8(2)==78&&n.getUint8(3)==71)return j(n);return null;}f.exports=l;l.gif=i;l.png=j;l.jpeg=k;},null);
__d('ChatAutoSendPhotoUploader',['csx','fbt','invariant','ArbiterMixin','AsyncUploadRequest','AsyncRequest','DOM','Event','FileForm','FileFormResetOnSubmit','FileInput','FormSubmitOnChange','JpegResizer','MercuryAttachmentType','MercuryConstants','PhotosMimeType','PhotosUploadID','Run','SubscriptionsHandler','URI','arrayContains','getImageSize','getObjectValues','isEmpty','mixin'],function a(b,c,d,e,f,g,h,i,j){'use strict';var k,l;if(c.__markCompiled)c.__markCompiled();function m(){return 'upload_'+c('PhotosUploadID').getNewID();}function n(p){return Array.prototype.reduce.call(p,function(q,r){var s=m();q[s]=r;return q;},{});}k=babelHelpers.inherits(o,c('mixin')(c('ArbiterMixin')));l=k&&k.prototype;function o(p,q,r){l.constructor.call(this);this.$ChatAutoSendPhotoUploader1=r;this.$ChatAutoSendPhotoUploader2=q;this.$ChatAutoSendPhotoUploader3=new (c('SubscriptionsHandler'))();this.$ChatAutoSendPhotoUploader4={};this.$ChatAutoSendPhotoUploader5={};this.$ChatAutoSendPhotoUploader6=false;this.$ChatAutoSendPhotoUploader7=p.getAttribute('action');this.$ChatAutoSendPhotoUploader8=new (c('FileForm'))(p,[c('FormSubmitOnChange'),c('FileFormResetOnSubmit')]);this.$ChatAutoSendPhotoUploader8.setAllowCrossOrigin(true);this.$ChatAutoSendPhotoUploader8.setUploadInParallel(true);var s=c('DOM').find(p,"._4q60"),t=c('DOM').find(s,"._4q61");this.$ChatAutoSendPhotoUploader9=new (c('FileInput'))(s,t,q);this.$ChatAutoSendPhotoUploader3.addSubscriptions(c('Run').onBeforeUnload(this.onBeforeUnload.bind(this)),this.$ChatAutoSendPhotoUploader8.subscribe('submit',this.$ChatAutoSendPhotoUploader10.bind(this)),this.$ChatAutoSendPhotoUploader8.subscribe('success',this.$ChatAutoSendPhotoUploader11.bind(this)),this.$ChatAutoSendPhotoUploader8.subscribe('failure',this.$ChatAutoSendPhotoUploader12.bind(this)),this.$ChatAutoSendPhotoUploader8.subscribe('progress',this.$ChatAutoSendPhotoUploader13.bind(this)),c('Event').listen(t,'click',function(){if(this.$ChatAutoSendPhotoUploader14===undefined)this.$ChatAutoSendPhotoUploader15();if(this.$ChatAutoSendPhotoUploader14)if(c('JpegResizer').prepareResource)c('JpegResizer').prepareResource();this.inform('open');}.bind(this)));}o.prototype.$ChatAutoSendPhotoUploader15=function(){this.$ChatAutoSendPhotoUploader14=c('JpegResizer').isSupported();if(this.$ChatAutoSendPhotoUploader14)this.$ChatAutoSendPhotoUploader8.setPreprocessHandler(this.$ChatAutoSendPhotoUploader16.bind(this));};o.prototype.onBeforeUnload=function(){if(this.isUploading()&&!this.$ChatAutoSendPhotoUploader6)return i._("You haven't sent your message yet. Do you want to leave without sending?");};o.prototype.isUploading=function(){return !c('isEmpty')(this.$ChatAutoSendPhotoUploader4);};o.prototype.destroy=function(){this.$ChatAutoSendPhotoUploader3.release();this.$ChatAutoSendPhotoUploader8.destroy();this.$ChatAutoSendPhotoUploader4={};this.$ChatAutoSendPhotoUploader5={};};o.prototype.$ChatAutoSendPhotoUploader17=function(p,q){var r=this.$ChatAutoSendPhotoUploader18(p);if(q){r.preview_width=q.width;r.preview_height=q.height;}return r;};o.prototype.$ChatAutoSendPhotoUploader18=function(p){var q={upload_id:p,on_progress:function(r){this.$ChatAutoSendPhotoUploader3.addSubscriptions(this.subscribe('progress',r));}.bind(this),on_resizing_progress:function(r){this.$ChatAutoSendPhotoUploader3.addSubscriptions(this.subscribe('resize_progress',r));}.bind(this),on_success:function(r){this.$ChatAutoSendPhotoUploader3.addSubscriptions(this.subscribe('success',r));}.bind(this),upload_canceled:this.$ChatAutoSendPhotoUploader19.bind(this),attach_type:c('MercuryAttachmentType').PHOTO,preview_uploading:true};return q;};o.prototype.$ChatAutoSendPhotoUploader16=function(p,q){var r=p.getFile();if(!c('PhotosMimeType').isJpeg(r.type))return q(p);c('JpegResizer').getSingleton().resizeBlob(r,function(s,t,u){if(t)p.setFile(t);q(p);},this.$ChatAutoSendPhotoUploader20.bind(this,p));};o.prototype.$ChatAutoSendPhotoUploader10=function(){var p=m();this.$ChatAutoSendPhotoUploader21(p,this.$ChatAutoSendPhotoUploader2.files);};o.prototype.$ChatAutoSendPhotoUploader21=function(p,q){var r=arguments.length<=2||arguments[2]===undefined?{}:arguments[2],s=0;for(var t=0;t<q.length;t++){var u=q[t];s+=u.size;if(s>c('MercuryConstants').AttachmentMaxSize){this.inform('file-upload-error',{error:'size-exceeded'});return;}if(u.type==='application/x-msdownload'||u.type==='application/x-msdownload-x64'){this.inform('file-upload-error',{error:'wrong-type'});return;}}if(typeof FileReader!=='undefined'&&FileReader.prototype.readAsArrayBuffer&&q&&q.length===1){this.$ChatAutoSendPhotoUploader4[p]=p;r[p]=q[0];var v=new FileReader();v.onload=function(){this.inform('submit',{upload_id:p,preview_attachments:[this.$ChatAutoSendPhotoUploader17(p,c('getImageSize')(v.result))]});}.bind(this);v.onerror=function(){this.inform('submit',{upload_id:p,preview_attachments:[this.$ChatAutoSendPhotoUploader18(p)]});}.bind(this);if(q[0].size){v.readAsArrayBuffer(q[0]);}else{var w=babelHelpers['extends']({},this.$ChatAutoSendPhotoUploader17(p,q[0].source),{preview_url:q[0].preview_url});this.inform('submit',{upload_id:p,preview_attachments:[w]});}}else{var x=[];if(!q){this.$ChatAutoSendPhotoUploader4[p]=p;this.$ChatAutoSendPhotoUploader1.value=p;x.push(this.$ChatAutoSendPhotoUploader18(p));}else{var y=Object.keys(r);if(y.length>0){y.forEach(function(ba){this.$ChatAutoSendPhotoUploader4[ba]=p;x.push(this.$ChatAutoSendPhotoUploader18(ba));}.bind(this));}else for(var z=0;z<q.length;++z){var aa=m();r[aa]=q[z];this.$ChatAutoSendPhotoUploader4[aa]=p;x.push(this.$ChatAutoSendPhotoUploader18(aa));}}this.inform('submit',{upload_id:p,preview_attachments:x});}if(Object.keys(r).length>0)this.$ChatAutoSendPhotoUploader8.setFiles(r);};o.prototype.$ChatAutoSendPhotoUploader11=function(event,p){var q=this.$ChatAutoSendPhotoUploader22(p);if(this.$ChatAutoSendPhotoUploader4[q]){var r=this.$ChatAutoSendPhotoUploader4[q];delete this.$ChatAutoSendPhotoUploader4[q];var s=p.response.getPayload();if(!this.$ChatAutoSendPhotoUploader5[r])this.$ChatAutoSendPhotoUploader5[r]=[];this.$ChatAutoSendPhotoUploader5[r].push({id:q,audio_id:s.metadata[0].audio_id,image_id:s.metadata[0].image_id,file_id:s.metadata[0].file_id,gif_id:s.metadata[0].gif_id,video_id:s.metadata[0].video_id});this.inform('success',{upload_id:q});if(!this.$ChatAutoSendPhotoUploader23(r))this.$ChatAutoSendPhotoUploader24(r);this.$ChatAutoSendPhotoUploader9.clear();this.$ChatAutoSendPhotoUploader2=this.$ChatAutoSendPhotoUploader9.getInput();}};o.prototype.$ChatAutoSendPhotoUploader24=function(p){!!this.$ChatAutoSendPhotoUploader23(p)?j(0):undefined;this.$ChatAutoSendPhotoUploader5[p].sort(function(q,r){return q.id<r.id?-1:1;});this.inform('all-uploads-completed',{upload_id:p,audio_ids:this.$ChatAutoSendPhotoUploader5[p].map(function(q){return q.audio_id;}),image_ids:this.$ChatAutoSendPhotoUploader5[p].map(function(q){return q.image_id;}),file_ids:this.$ChatAutoSendPhotoUploader5[p].map(function(q){return q.file_id;}),gif_ids:this.$ChatAutoSendPhotoUploader5[p].map(function(q){return q.gif_id;}),video_ids:this.$ChatAutoSendPhotoUploader5[p].map(function(q){return q.video_id;})});delete this.$ChatAutoSendPhotoUploader5[p];};o.prototype.$ChatAutoSendPhotoUploader13=function(event,p){this.inform('progress',{upload_id:p.upload.getName(),event:p.event});};o.prototype.$ChatAutoSendPhotoUploader20=function(p,event){this.inform('resize_progress',{upload_id:p.getName(),event:event});};o.prototype.$ChatAutoSendPhotoUploader23=function(p){return c('arrayContains')(c('getObjectValues')(this.$ChatAutoSendPhotoUploader4),p);};o.prototype.$ChatAutoSendPhotoUploader12=function(event,p){var q=this.$ChatAutoSendPhotoUploader22(p);this.$ChatAutoSendPhotoUploader25(q,'last-upload-failed',p.additionalParams);this.$ChatAutoSendPhotoUploader9.clear();this.$ChatAutoSendPhotoUploader2=this.$ChatAutoSendPhotoUploader9.getInput();return false;};o.prototype.$ChatAutoSendPhotoUploader19=function(p){this.$ChatAutoSendPhotoUploader25(p,'last-upload-canceled');};o.prototype.$ChatAutoSendPhotoUploader25=function(p,q,r){if(!this.$ChatAutoSendPhotoUploader4[p])return;var s=this.$ChatAutoSendPhotoUploader4[p];delete this.$ChatAutoSendPhotoUploader4[p];if(!this.$ChatAutoSendPhotoUploader23(s))if(this.$ChatAutoSendPhotoUploader5[s]){this.$ChatAutoSendPhotoUploader24(s);}else this.inform(q,babelHelpers['extends']({upload_id:s},r));};o.prototype.$ChatAutoSendPhotoUploader22=function(p){if(p.upload){return p.upload.getName();}else return p.response.getPayload().uploadID;};o.prototype.uploadFiles=function(p){var q=m(),r;if(p.length===1){var s;r=(s={},s[q]=p[0],s);}else r=n(p);var t=new (c('AsyncUploadRequest'))(this.$ChatAutoSendPhotoUploader7).setAllowCrossOrigin(true).setAllowCrossPageTransition(this.$ChatAutoSendPhotoUploader6).setRelativeTo(this.$ChatAutoSendPhotoUploader8.getRoot()).setFiles(r);this.$ChatAutoSendPhotoUploader3.addSubscriptions(t.subscribe('success',function(event,u){this.$ChatAutoSendPhotoUploader11(event,{upload:u,response:u.getResponse()});}.bind(this)),t.subscribe('failure',this.$ChatAutoSendPhotoUploader12.bind(this)));t.send();this.$ChatAutoSendPhotoUploader21(q,p,r);};o.prototype.uploadURL=function(p){var q=m(),r=p.errorDialogParams;delete p.errorDialogParams;var s=new (c('AsyncRequest'))().setURI(new (c('URI'))(this.$ChatAutoSendPhotoUploader7).getPath()).setAllowCrossPageTransition(this.$ChatAutoSendPhotoUploader6).setData(babelHelpers['extends']({},p,{attach_id:q})).setErrorHandler(function(t){this.$ChatAutoSendPhotoUploader12(null,{additionalParams:{errorDialogParams:r},response:{getPayload:function(){return {uploadID:q};}}});}.bind(this)).setHandler(function(t){this.$ChatAutoSendPhotoUploader11(null,{response:t});}.bind(this));s.send();this.$ChatAutoSendPhotoUploader21(q,[p]);};o.prototype.setAllowCrossPage=function(p){this.$ChatAutoSendPhotoUploader6=p;this.$ChatAutoSendPhotoUploader8.setAllowCrossPageTransition(p);};f.exports=o;},null);